<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…éŠåˆ†å¸³ PRO - è±ªè¯ç‰ˆ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { 
            --primary: #4a90e2; 
            --bg: #f5f7fa; 
            --up: #2ecc71; 
            --down: #e74c3c; 
            --orange: #f39c12; 
            --gold: #FFD700; 
            --silver: #C0C0C0; 
            --bronze: #CD7F32; 
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; }
        header { background: var(--primary); color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 100; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .page { display: none; padding: 15px; animation: fadeIn 0.2s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        h3 { margin-top: 0; font-size: 1.1em; color: #333; border-left: 4px solid var(--primary); padding-left: 10px; margin-bottom: 12px; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.85em; color: #666; margin-bottom: 6px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 8px; background: #f9f9f9; padding: 10px; border-radius: 8px; border: 1px solid #eee; }
        .checkbox-item { display: flex; align-items: center; background: white; padding: 5px 10px; border-radius: 20px; border: 1px solid #ddd; font-size: 0.9em; }
        .checkbox-item input { width: auto; margin-right: 5px; }

        .btn { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 8px; width: 100%; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn:disabled { background: #ccc; }
        
        .item-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dotted #eee; font-size: 0.9em; align-items: center; }
        
        /* å¢Šä»˜æ’è¡Œæ¨£å¼ */
        .rank-badge { width: 22px; height: 22px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; margin-right: 8px; font-weight: bold; color: white; font-size: 0.75em; }
        .rank-1 { background-color: var(--gold); box-shadow: 0 0 5px var(--gold); }
        .rank-2 { background-color: var(--silver); }
        .rank-3 { background-color: var(--bronze); }

        /* çµç®—ç›’æ¨£å¼ */
        .settle-box { background: #fff; padding: 12px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .settle-name { font-weight: bold; padding: 4px 10px; border-radius: 6px; font-size: 0.9em; }
        .name-pay { color: var(--down); background: #fff5f5; border: 1px solid #feb2b2; }
        .name-get { color: var(--up); background: #f0fff4; border: 1px solid #9ae6b4; }
        
        nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; border-top: 1px solid #eee; height: 65px; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #888; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; visibility: hidden; }
    </style>
</head>
<body>

<div id="loading-overlay"><i class="fas fa-spinner fa-spin fa-2x" style="color:var(--primary)"></i><p>åŒæ­¥é›²ç«¯è³‡æ–™...</p></div>

<header id="h-title">æ–°å¢æ”¯å‡º</header>

<div id="p-input" class="page active">
    <div class="card">
        <div class="form-group">
            <label>ä»˜æ¬¾äºº (æ–°æœ‹å‹ç›´æ¥è¼¸å…¥å³å¯)</label>
            <input type="text" id="payer" list="name-list" placeholder="æ˜¯èª°å¢ŠéŒ¢çš„ï¼Ÿ">
            <datalist id="name-list"></datalist>
        </div>
        
        <div class="form-group">
            <label>é‡‘é¡èˆ‡å¹£åˆ¥</label>
            <div style="display: flex; gap: 5px;">
                <input type="number" id="amount" placeholder="é‡‘é¡" inputmode="decimal" style="flex:2">
                <select id="currency" style="flex:1" onchange="updateRateUI()">
                    <option value="TWD">å°å¹£</option>
                    <option value="JPY">æ—¥å¹£</option>
                </select>
            </div>
            <div id="rate-display" style="font-size: 11px; color: #999; margin-top: 5px;">åŒ¯ç‡è¼‰å…¥ä¸­...</div>
        </div>

        <div class="form-group">
            <label>é …ç›®</label>
            <input type="text" id="item" placeholder="ä¾‹å¦‚ï¼šé£¯åº—ã€æ™šé¤">
        </div>

        <div class="form-group">
            <label>åˆ†å¸³æˆå“¡ (èª°åƒèˆ‡äº†é€™ç­†ï¼Ÿ)</label>
            <div id="members-area" class="checkbox-group"></div>
            <div style="display: flex; gap: 5px; margin-top: 10px;">
                <input type="text" id="new-member" placeholder="æ–°æˆå“¡åç¨±" style="padding: 8px;">
                <button type="button" onclick="addNewMember()" style="width: 60px; border-radius: 8px; border: 1px solid #ddd; background: #fff;">+</button>
            </div>
        </div>

        <button class="btn" id="save-btn" onclick="addRecord()">å­˜å…¥é›²ç«¯è³‡æ–™åº«</button>
    </div>
</div>

<div id="p-status" class="page">
    <div class="card">
        <h3>ğŸš€ æœ€çŸ­é‚„æ¬¾æ–¹æ¡ˆ (TWD)</h3>
        <div id="settlement-plan"></div>
    </div>

    <div class="card">
        <h3>ğŸ† å¢Šä»˜è²¢ç»æ’è¡Œæ¦œ</h3>
        <div id="payment-summary"></div>
    </div>

    <div class="card">
        <h3>ğŸ“Š æœ€çµ‚æç›Š (æ‡‰æ”¶/æ‡‰ä»˜)</h3>
        <div id="personal-summary"></div>
    </div>

    <div class="card" style="background: #fafafa;">
        <h3>ğŸ“œ æ­·å²ç´€éŒ„ (å«æ™‚é–“)</h3>
        <div id="history-list"></div>
    </div>
    
    <button class="btn" style="background: #666;" onclick="initData()">æ‰‹å‹•é‡æ–°åŒæ­¥</button>
</div>

<nav>
    <div class="nav-item active" onclick="switchPage('input')"><i class="fas fa-edit"></i><span>è¨˜å¸³</span></div>
    <div class="nav-item" onclick="switchPage('status')"><i class="fas fa-calculator"></i><span>çµç®—</span></div>
</nav>

<script>
    // ä½ çš„ GAS ç¶²å€å·²åµŒå…¥
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbwgmHOOhdgywLdsP3oW_5kSCwwSVtfm22Kwhj9bEFQXr1mk9XayKxTLF478sSYh623x/exec'; 

    let records = [];
    let members = ["ä¸€è™Ÿ", "è©©æ½”", "Yuzugi", "å°ç‘œ", "è€æ", "æ ©ç¿”"]; 
    let jpyRate = 0.21;

    // åˆå§‹åŒ–èˆ‡æŠ“å–
    async function initData() {
        document.getElementById('loading-overlay').style.visibility = 'visible';
        try {
            const res = await fetch(GAS_URL);
            const data = await res.json();
            
            records = data.map(row => ({
                date: row[0] ? new Date(row[0]).toLocaleString('zh-TW', {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'}) : '',
                payer: row[1],
                item: row[2],
                amount: parseFloat(row[3]),
                curr: row[4],
                members: JSON.parse(row[5])
            }));

            records.forEach(r => {
                if(!members.includes(r.payer)) members.push(r.payer);
                r.members.forEach(m => { if(!members.includes(m)) members.push(m); });
            });
            renderMemberCheckboxes();
        } catch (e) {
            console.error("æŠ“å–å¤±æ•—", e);
        } finally {
            document.getElementById('loading-overlay').style.visibility = 'hidden';
        }
    }

    function renderMemberCheckboxes() {
        const area = document.getElementById('members-area');
        const datalist = document.getElementById('name-list');
        area.innerHTML = ''; datalist.innerHTML = '';
        members.forEach(m => {
            area.innerHTML += `<label class="checkbox-item"><input type="checkbox" name="member-check" value="${m}" checked> ${m}</label>`;
            datalist.innerHTML += `<option value="${m}">`;
        });
    }

    function addNewMember() {
        const name = document.getElementById('new-member').value.trim();
        if (name && !members.includes(name)) {
            members.push(name);
            renderMemberCheckboxes();
            document.getElementById('new-member').value = '';
        }
    }

    async function fetchRate() {
        try {
            const res = await fetch('https://open.er-api.com/v6/latest/JPY');
            const data = await res.json();
            jpyRate = data.rates.TWD;
            document.getElementById('rate-display').innerText = `å³æ™‚åŒ¯ç‡ï¼š1 JPY â‰ˆ ${jpyRate.toFixed(4)} TWD`;
        } catch (e) { document.getElementById('rate-display').innerText = `åŒ¯ç‡é€£ç¶²å¤±æ•—ï¼Œé è¨­ 0.21`; }
    }

    async function addRecord() {
        const payer = document.getElementById('payer').value.trim();
        const item = document.getElementById('item').value.trim();
        const amount = parseFloat(document.getElementById('amount').value);
        const curr = document.getElementById('currency').value;
        const checkedMembers = Array.from(document.querySelectorAll('input[name="member-check"]:checked')).map(el => el.value);

        if(!payer || !amount || checkedMembers.length === 0) return alert('è«‹æª¢æŸ¥ä»˜æ¬¾äººã€é‡‘é¡èˆ‡æˆå“¡');

        const twdAmount = curr === 'JPY' ? amount * jpyRate : amount;
        const payload = { payer, item, amount: twdAmount, curr, members: checkedMembers };

        const btn = document.getElementById('save-btn');
        btn.disabled = true; btn.innerText = "ä¸Šå‚³ä¸­...";

        try {
            await fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
            alert('ä¸Šå‚³æˆåŠŸï¼è³‡æ–™å·²åŒæ­¥è‡³é›²ç«¯ã€‚');
            location.reload(); // é‡æ–°æ•´ç†ç¢ºä¿æŠ“åˆ°æœ€æ–°çš„è³‡æ–™åº«æ™‚é–“
        } catch (e) {
            alert('é€£ç·šå¤±æ•—');
            btn.disabled = false; btn.innerText = "å­˜å…¥é›²ç«¯è³‡æ–™åº«";
        }
    }

    function calculateAll() {
        let balances = {}; let totalPaid = {};
        members.forEach(m => { balances[m] = 0; totalPaid[m] = 0; });

        const historyDiv = document.getElementById('history-list');
        historyDiv.innerHTML = '';

        records.forEach(r => {
            const share = r.amount / r.members.length;
            totalPaid[r.payer] = (totalPaid[r.payer] || 0) + r.amount;
            balances[r.payer] += r.amount;
            r.members.forEach(m => {
                balances[m] = (balances[m] || 0) - share;
            });

            historyDiv.innerHTML += `
                <div class="item-row">
                    <div style="display:flex; flex-direction:column">
                        <b>${r.payer}: ${r.item}</b>
                        <small style="color:#aaa">${r.date}</small>
                    </div>
                    <span>$${Math.round(r.amount)}</span>
                </div>`;
        });

        // 1. å¢Šä»˜æ’è¡Œæ¦œ (æ¨™è¨˜å‰ä¸‰å)
        const sortedPayments = Object.entries(totalPaid).filter(e => e[1] > 0).sort((a,b) => b[1] - a[1]);
        const payDiv = document.getElementById('payment-summary');
        payDiv.innerHTML = '';
        sortedPayments.forEach(([name, amt], index) => {
            let badgeClass = '';
            if(index === 0) badgeClass = 'rank-1';
            else if(index === 1) badgeClass = 'rank-2';
            else if(index === 2) badgeClass = 'rank-3';
            
            const badge = badgeClass ? `<span class="rank-badge ${badgeClass}">${index+1}</span>` : `<span class="rank-badge" style="background:#ddd;color:#666">${index+1}</span>`;
            
            payDiv.innerHTML += `
                <div class="item-row">
                    <span>${badge}${name}</span>
                    <span style="color:var(--orange); font-weight:bold;">$${Math.round(amt)}</span>
                </div>`;
        });

        // 2. æœ€çµ‚æç›Š
        const summaryDiv = document.getElementById('personal-summary');
        summaryDiv.innerHTML = '';
        for (let name in balances) {
            const b = Math.round(balances[name]);
            if (Math.abs(b) < 1) continue;
            summaryDiv.innerHTML += `
                <div class="item-row">
                    <span>${name}</span>
                    <span style="color:${b > 0 ? 'var(--up)' : 'var(--down)'}; font-weight:bold;">
                        ${b > 0 ? 'æ‡‰æ”¶å›' : 'æ‡‰æ”¯ä»˜'} $${Math.abs(b)}
                    </span>
                </div>`;
        }

        // 3. æœ€çŸ­é‚„æ¬¾æ–¹æ¡ˆ (é¡è‰²æ¨™è¨˜)
        const planDiv = document.getElementById('settlement-plan');
        planDiv.innerHTML = '';
        let debtors = [], creditors = [];
        for (let n in balances) {
            if (balances[n] < -0.5) debtors.push({n, amt: Math.abs(balances[n])});
            else if (balances[n] > 0.5) creditors.push({n, amt: balances[n]});
        }
        while(debtors.length && creditors.length) {
            debtors.sort((a,b) => b.amt - a.amt);
            creditors.sort((a,b) => b.amt - a.amt);
            let d = debtors[0], c = creditors[0], settle = Math.min(d.amt, c.amt);
            planDiv.innerHTML += `
                <div class="settle-box">
                    <span class="settle-name name-pay">${d.n}</span>
                    <div style="text-align:center; flex:1">
                        <i class="fas fa-long-arrow-alt-right" style="color:#ccc"></i>
                        <div style="font-weight:bold; font-size:1.1em">$${Math.round(settle)}</div>
                    </div>
                    <span class="settle-name name-get">${c.n}</span>
                </div>`;
            d.amt -= settle; c.amt -= settle;
            if(d.amt < 0.5) debtors.shift();
            if(c.amt < 0.5) creditors.shift();
        }
        if(!planDiv.innerHTML) planDiv.innerHTML = "<p style='color:#999; text-align:center;'>ç›®å‰å¸³ç›®å®Œå…¨å¹³è¡¡</p>";
    }

    function switchPage(p) {
        document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        if(p === 'input') {
            document.getElementById('p-input').classList.add('active');
            document.querySelectorAll('.nav-item')[0].classList.add('active');
            document.getElementById('h-title').innerText = "æ–°å¢æ”¯å‡º";
        } else {
            document.getElementById('p-status').classList.add('active');
            document.querySelectorAll('.nav-item')[1].classList.add('active');
            document.getElementById('h-title').innerText = "çµç®—ä¸­å¿ƒ";
            calculateAll();
        }
    }

    function updateRateUI() {
        const curr = document.getElementById('currency').value;
        document.getElementById('rate-display').style.display = (curr === 'JPY') ? 'block' : 'none';
    }

    window.onload = () => {
        fetchRate();
        initData();
        renderMemberCheckboxes();
    };
</script>
</body>
</html>